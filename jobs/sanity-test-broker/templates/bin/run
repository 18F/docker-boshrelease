#!/bin/bash

exec 2>&1

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the errand script
source /var/vcap/jobs/sanity-test-broker/helpers/ctl_setup.sh 'sanity-test-broker'

############################################################################

<%
  broker = link("servicebroker")
  protocol = broker.p("protocol", broker.p("ssl_enabled", false) ? "https" : "http")
  username = broker.p("username")
  password = broker.p("password")
  host = broker.p("external_host", broker.instances.first.address)
  uri = "#{protocol}://#{username}:#{password}@#{host}"
  redacted_uri = "#{protocol}://#{username}:REDACTED@#{host}"
  broker.if_p("port") do |broker_port|
    uri += ":#{broker_port}"
    redacted_uri += ":#{broker_port}"
  end

  services = broker.p("services")
  service_names = services.map {|s| s["name"]}.join(",")
-%>
export uri=<%= uri %>

echo Pinging $redacted_uri/v2/catalog for service names...
curl -s $uri/v2/catalog | jq -r ".services | map(.name) | join(\",\")"
service_names=$(curl -s $uri/v2/catalog | jq -r ".services | map(.name) | join(\",\")")

echo Testing <%= service_names %> == $service_names
if [[ "$service_names" != "<%= service_names %>" ]]; then
  echo "Failed"
  exit 1
else
  echo "Ok"
fi
